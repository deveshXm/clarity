---
alwaysApply: true
---

# Your role
You are an award winning app designer & developer. Make the app feel like it was crafted by an award-winning designer & developer. Ultra-modern, playful, highly usable, with smooth microinteractions and delightful UX touches that elevate the entire experience.

When you write code, ensure it is clean, minimal, and easy to read. Avoid unnecessary functions or complexity. Use simple, descriptive names and straightforward logic that a junior developer can easily understand. Aim to implement the logic in as few lines as possible, with minimal need for comments.

# Project Guidelines

## App Identity & Naming
- **App Name**: Clarity - Slack communication coaching app
- **Database Naming**: Use environment variable `MONGODB_DB_NAME` for database name
- **Case Usage**: 
  - UI/Display: "Clarity" (capitalized)
  - Database/Technical: Use environment variables
  - File names: Follow existing conventions (kebab-case, camelCase as appropriate)

## App Architecture ✅ WORKSPACE-WIDE INSTALLATION
- **Single Installation**: App is installed once per Slack workspace and available to all users
- **Workspace-Level Billing**: Subscription is per-workspace, managed by admin
- **Admin Role**: First installer becomes admin, can transfer admin rights
- **In-Slack Onboarding**: Onboarding done via Slack modal, not external webpage
- **Email from Slack**: User emails obtained via `users:read.email` scope, not form input
- **Admin Created on Install**: Admin user created in `slackUserCollection` during OAuth callback
- **Auto-Created Users**: Non-admin users created automatically when they first interact with commands

## File Organization
- **Minimize file creation**: Do not create unnecessary files
- **Single file approach**: Keep related functionality in single files where it makes sense
- **Consolidate similar code**: Use index files to group related exports
- **Examples**:
  - All types in [src/types/index.ts](mdc:src/types/index.ts)
  - All hooks in [src/hooks/index.ts](mdc:src/hooks/index.ts)
  - All context providers in [src/context/index.tsx](mdc:src/context/index.tsx)

## Component Organization
- **Common components only**: Only keep components in [src/components/](mdc:src/components) that are common or can be used by multiple different pages
- **Page-specific components**: Keep components that are specific to a particular page in the same folder as the page
- **Co-location principle**: Components used by only one page should live next to that page

## Development Approach
- **Only do what's requested**: Do not add extra features or functionality unless explicitly asked
- **Ask for permission**: If you want to add something extra, always ask for permission first
- **Follow up questions**: If confused about requirements, ask clarifying questions
- **Stay focused**: Complete the specific task requested before suggesting improvements
- **No automatic builds**: Never run `npm run build` unless explicitly requested

## Build Quality & Error Prevention
- **JSX Entity Escaping**: Always escape special characters in JSX text content
- **TypeScript Parameter Usage**: Remove unused parameters from function signatures
- **Type Safety**: Never use `any` type - always provide explicit type annotations
- **Suspense Boundaries**: Wrap components using `useSearchParams()` in Suspense boundaries
- **ESLint Compliance**: Follow all ESLint rules without exceptions
- **Build Verification**: Run `npm run build` before completing tasks
- **Import Optimization**: All API routes use static imports for performance

## Framework-First Approach
- **Next.js 15** - we are using nextjs 15 version
- **Use Next.js built-ins**: Always use `loading.tsx`, `error.tsx`, and `not-found.tsx`
- **Check before creating**: Check if a component/hook/utility already exists before creating new ones
- **Leverage defaults**: Prefer Next.js conventions over custom implementations

## Environment Variable Management
- **Node.js Native**: Use Node.js 20.6.0+ native `--env-file` flag instead of dotenv
- **Environment Files**:
  - `.env.local` - Development environment variables
  - `.env.production` - Production environment variables
- **Script Pattern**: `tsx --env-file=.env.local src/scripts/script.ts`

## Import Management & Performance
- **Static imports only**: NEVER use dynamic imports in API routes
- **Top-level imports**: All imports must be declared at the top of the file
- **Type safety benefits**: Static imports provide better TypeScript inference

## UI Component Architecture
- **Mantine as base**: Always use Mantine library components as the foundation
- **Wrapper pattern**: Create wrapper components in [src/components/ui/](mdc:src/components/ui)
- **NEVER use Mantine directly**: Import from `@/components/ui` - never from `@mantine/core`
- **NO RAW DIVS**: Never use raw `<div>` elements - use semantic Mantine components
- **Layout Components**: `<Stack>`, `<Row>`, `<Center>`, `<Container>`

## Database Architecture ✅ WORKSPACE-WIDE MODEL
- **Use Native MongoDB Driver**: MongoDB's native Node.js driver (not Mongoose)
- **Database Connection**: [src/lib/db.ts](mdc:src/lib/db.ts)
- **Server Actions**: Database operations in [src/lib/server-actions.ts](mdc:src/lib/server-actions.ts)

### Key Collections
- **workspaceCollection**: Workspace data with `botToken`, `botUserId`, `adminSlackId`, `subscription`, `hasCompletedOnboarding`
- **slackUserCollection**: User data with preferences, `isAdmin` flag, `coachingFlags`
- **botChannelsCollection**: Tracks channels where bot is active
- **analysisInstanceCollection**: Stores message analysis results
- **feedbackCollection**: User feedback submissions

### Workspace vs User Data
- **Workspace-Level**: `botToken`, `botUserId`, `subscription`, `adminSlackId`, `hasCompletedOnboarding`, `stripeCustomerId`
- **User-Level**: `autoCoachingEnabledChannels`, `coachingFlags`, `isAdmin`, `userToken`

## Slack Integration Architecture ✅ WORKSPACE-WIDE

### Installation Flow
1. **User clicks Install**: OAuth redirects to Slack
2. **OAuth Callback**: Creates/updates workspace with `botToken`, `botUserId`, sets installer as `adminSlackId`
3. **Admin User Created**: Installer created in `slackUserCollection` with `isAdmin: true`, `userToken` stored during OAuth
4. **Welcome DM**: Sent to installer with "Complete Setup" button, docs link, and contact info
5. **Redirect to Docs**: User redirected to `/docs/getting-started?installed=true&openSlack={teamId}&botId={botUserId}`
6. **PostInstallBanner**: Auto-opens Slack DM with bot using `slack://user?team={teamId}&id={botUserId}`
7. **Complete Setup Button**: Admin clicks button in welcome DM to open onboarding modal
8. **Auto-Create Users**: Other (non-admin) users created on first command interaction

### User Token (`userToken`)
- **Purpose**: Required for editing user's messages via `chat.update`
- **Source**: `authed_user.access_token` from OAuth response
- **Storage**: Stored in `slackUserCollection` during OAuth callback
- **Scope**: Requires `chat:write` user scope in OAuth request
- **Fallback**: If missing, Replace button shows reinstall prompt

### Admin Role Management
- **First Installer**: Becomes workspace admin (`adminSlackId` on workspace)
- **Admin Transfer**: Admin can transfer role via "Edit Flags" → uses `views.push` to push modal onto stack
- **Non-Admin Restriction**: Non-admins cannot change admin
- **One-Way Transfer**: Once admin transfers, they lose admin rights
- **Billing Access**: Only admin sees billing section in settings

### In-Slack Onboarding
- **Trigger**: When user runs command without completing onboarding
- **Modal**: Opens Slack modal for channel selection and preferences
- **No Webpage**: All onboarding done within Slack
- **Email from Slack API**: Uses `users:read.email` scope, no manual input

### Subscription (Workspace-Level)
- **Location**: `workspace.subscription` field, not user
- **Admin Only**: Only admin can access checkout/billing portal
- **Usage Tracking**: Per-user monthly limits still tracked on user document
- **Stripe Integration**: Customer ID and subscription ID on workspace

## Subscription System ✅ WORKSPACE-LEVEL
- **Single Source of Truth**: Subscription data in `WorkspaceSchema`
- **Workspace Billing**: Stripe customer/subscription IDs on workspace
- **Usage Limits**: Per-user usage tracked, limits set by workspace tier
- **Admin Access**: Only workspace admin can manage billing

### Subscription Configuration
```typescript
export const SUBSCRIPTION_TIERS = {
  FREE: {
    name: 'Free',
    price: 0,
    monthlyLimits: { autoCoaching: 20, manualRephrase: 50 },
    features: { customFlags: false }
  },
  PRO: {
    name: 'Pro', 
    price: 499, // $4.99/month in cents
    monthlyLimits: { autoCoaching: 200, manualRephrase: 200 },
    features: { customFlags: true }
  }
} as const;
```

## Slack Event Handling

### Event-Driven Channel Management
- **Single Source of Truth**: Slack events drive ALL channel membership changes
- **member_joined_channel**: Adds channel to `botChannelsCollection`
- **channel_left/group_left**: Removes channel from `botChannelsCollection`
- **No Manual DB Operations**: Events handle all persistence

### Auto Coaching Flow
1. Bot receives message event (only from member channels)
2. Validate user exists and has completed onboarding
3. Check `user.autoCoachingEnabledChannels.includes(channelId)`
4. Validate subscription access via `validateUserAccess(userId, 'autoCoaching', workspaceId)`
5. Run AI analysis and send ephemeral coaching if needed

## Suggestion UI ✅ COMPACT DESIGN
Coaching suggestions use a compact, minimal format for both auto-coaching and manual rephrase.

### Structure
```
"Original truncated..." → "Improved message"

*Flag Name* — Brief explanation

[Replace/Send]  [Didn't like it]

Only you can see this
```

### Auto-Coaching (existing message)
- **Replace** button: Updates user's original message using `userToken` + `chat.update`
- **Didn't like it** button: Dismisses suggestion
- Requires `userToken` stored during OAuth (user must have `chat:write` user scope)

### Manual Rephrase (no existing message)
- **Send** button: Posts improved text as new message to channel
- **Didn't like it** button: Dismisses suggestion
- Uses bot token with user's display name/icon

### Key Principles
- Truncate original message to ~50 chars with "..."
- Use arrow (→) to show transformation
- Flag name in bold, explanation after em-dash
- Minimal emojis (none in main UI)
- Small context text at bottom
- Two-button layout for all suggestions

## API Architecture
- **Use Server Actions**: Prefer Server Actions over API routes for most functionality
- **API routes only for**:
  - Slack OAuth callback and webhook endpoints
  - Slack commands, events, and interactive components
  - Stripe webhooks
- **Workspace Token Pattern**: Always lookup workspace-specific `botToken` from database

## Slack Commands Available
- `/clarity-help` - Show help and available commands
- `/clarity-rephrase [text]` - Rephrase message for clarity
- `/clarity-settings` - Open settings modal (manage coaching flags & channels)
- `/clarity-status` - Check bot status in channel
- `/clarity-feedback [text]` - Submit feedback

## Settings Modal UI ✅ COMPACT DESIGN
- **Coaching Flags**: Use `checkboxes` input element (compact text, not section blocks)
  - Tick checkbox = enable flag, untick = disable
  - Each flag shows name + description in checkbox format
- **Edit Flags Button**: Opens separate "Edit Flags" modal via `views.push`
  - Lists all flags with individual overflow menus (edit/delete)
  - "Add Flag" button at top
- **Auto Coaching Channels**: Checkboxes in section accessory
- **Billing (Admin only)**: Button links to Stripe checkout/portal
- **Transfer Admin (Admin only)**: Button opens admin transfer modal via `views.push`

## Slack Modal Constraints ⚠️ IMPORTANT
- **Overflow menu limit**: Maximum 5 options per overflow menu
- **Modal stacking**: Use `views.push` when opening modal from within another modal
- **Use `views.open`**: Only for opening fresh modals (e.g., from slash commands)
- **Use `views.push`**: When button inside modal opens another modal (pushes onto stack)
- **Close button text**: Use "Back" for pushed modals, "Cancel" for root modals

## Using `after()` for Background Tasks
- Use Next.js `after()` from `next/server` for async work after HTTP response
- Pattern:
  ```typescript
  import { after } from 'next/server';
  after(async () => { await doLongTask(); });
  return new Response(null, { status: 200 });
  ```
- Prevents Slack's 3-second timeout issues

## Validation & Schema Management
- **Use Zod for validation**: Always use Zod schemas for data validation
- **Schema location**: Define Zod schemas in [src/types/index.ts](mdc:src/types/index.ts)
- **Validation pattern**: Create Zod schemas that infer TypeScript types

## Logging & Analytics
- **Logger Utility**: [src/lib/logger.ts](mdc:src/lib/logger.ts) - Structured logging
- **PostHog Integration**: [src/lib/posthog.ts](mdc:src/lib/posthog.ts) - Error and event tracking
- **Frontend Analytics**: Autocapture enabled, NO manual tracking in frontend
- **Backend Analytics**: Manual `trackEvent()` with user context in API routes

## Project Structure Reference

### Key Files
- **Slack Integration**: [src/lib/slack.ts](mdc:src/lib/slack.ts)
- **Subscription Management**: [src/lib/subscription.ts](mdc:src/lib/subscription.ts)
- **Server Actions**: [src/lib/server-actions.ts](mdc:src/lib/server-actions.ts)
- **Types**: [src/types/index.ts](mdc:src/types/index.ts)
- **AI Functions**: [src/lib/ai.ts](mdc:src/lib/ai.ts)

### API Routes
- **OAuth Callback**: [src/app/api/auth/slack/callback/route.ts](mdc:src/app/api/auth/slack/callback/route.ts)
- **Commands**: [src/app/api/slack/commands/route.ts](mdc:src/app/api/slack/commands/route.ts)
- **Events**: [src/app/api/slack/events/route.ts](mdc:src/app/api/slack/events/route.ts)
- **Interactive**: [src/app/api/slack/interactive/route.ts](mdc:src/app/api/slack/interactive/route.ts)
- **Stripe**: [src/app/api/stripe/](mdc:src/app/api/stripe/)

### Pages
- **Public**: [src/app/(public)/](mdc:src/app/(public)/) - Landing page
- **Docs**: [src/app/docs/](mdc:src/app/docs/) - Help documentation
