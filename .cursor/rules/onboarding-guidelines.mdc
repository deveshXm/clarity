---
globs: src/app/api/slack/**/*.ts,src/lib/slack.ts
---

# In-Slack Onboarding Guidelines

Onboarding is now done entirely within Slack using modals, not via external webpages.

## Architecture ‚úÖ IN-SLACK MODAL

### Trigger Points
- Admin clicks "Complete Setup" button in welcome DM after installation
- User runs any feature command (`/clarity-rephrase`, `/clarity-settings`, etc.) without completing onboarding
- System opens onboarding modal via `views.open`

### Modal Flow
1. **Welcome Step**: Brief intro to Clarity features
2. **Channel Selection**: Choose channels for auto-coaching (checkboxes)
3. **Completion**: Save preferences and mark `hasCompletedOnboarding: true`

## Implementation Files

### Modal Definition
- **Commands Route**: [src/app/api/slack/commands/route.ts](mdc:src/app/api/slack/commands/route.ts) - Triggers modal when user hasn't onboarded
- **Interactive Route**: [src/app/api/slack/interactive/route.ts](mdc:src/app/api/slack/interactive/route.ts) - Handles `onboarding_modal` submission
- **Slack Functions**: [src/lib/slack.ts](mdc:src/lib/slack.ts) - `sendOnboardingPromptMessage()` function

### User Creation
- **Admin user created during OAuth**: Installer is created in `slackUserCollection` with `isAdmin: true` immediately during OAuth callback
- **Other users auto-created**: Non-admin users created on first command interaction
- Email obtained from Slack API via `users:read.email` scope
- No manual email collection during onboarding

### Welcome DM with Setup Button
- After installation, admin receives welcome DM with "Complete Setup" button
- Button triggers `complete_onboarding` action in interactive handler
- Opens onboarding modal for channel selection and preferences
- Non-admin clicking button gets message to ask admin

### Post-Install Deep Link Flow ‚úÖ NEW
- **OAuth redirect**: After install, redirect to `/docs/getting-started?installed=true&openSlack={teamId}&botId={botUserId}`
- **PostInstallBanner component**: Shows on docs page after installation
- **Auto-opens Slack**: Uses `slack://user?team={teamId}&id={botUserId}` to open bot DM directly
- **Fallback options**: "Open Slack" button + "Open in browser" link
- **Steps shown**: Clear 3-step guide to complete setup in Slack
- **Component location**: [src/app/docs/_components/PostInstallBanner.tsx](mdc:src/app/docs/_components/PostInstallBanner.tsx)

## Modal Structure

```typescript
// Opening onboarding modal
const modal = {
  type: 'modal',
  callback_id: 'onboarding_modal',
  title: { type: 'plain_text', text: 'Clarity Setup' },
  blocks: [
    // Welcome section
    {
      type: 'section',
      text: {
        type: 'mrkdwn',
        text: '*Welcome to Clarity!* üéâ\n\nLet\'s get you set up to improve your team communication.'
      }
    },
    // Channel selection (checkboxes)
    {
      type: 'input',
      block_id: 'channels_block',
      optional: true,
      element: {
        type: 'checkboxes',
        action_id: 'selected_channels',
        options: channelOptions
      },
      label: { type: 'plain_text', text: 'Enable auto-coaching in channels' }
    }
  ],
  submit: { type: 'plain_text', text: 'Complete Setup' }
};
```

## Submission Handling

```typescript
// In interactive handler
if (callbackId === 'onboarding_modal') {
  const values = payload.view.state.values;
  const selectedChannels = values.channels_block?.selected_channels?.selected_options || [];
  
  // Update user preferences
  await slackUserCollection.updateOne(
    { slackId: userId, workspaceId: workspace._id.toString() },
    {
      $set: {
        autoCoachingEnabledChannels: selectedChannels.map(c => c.value),
        hasCompletedOnboarding: true,
        updatedAt: new Date()
      }
    }
  );
  
  // Optional: Send workspace announcement if first user
  if (!workspace.hasCompletedOnboarding) {
    await sendWorkspaceAnnouncement(workspace, userId);
    await workspaceCollection.updateOne(
      { _id: workspace._id },
      { $set: { hasCompletedOnboarding: true } }
    );
  }
}
```

## Key Principles

### No External Webpages for Onboarding
- ‚ùå Don't redirect to `/app/onboarding` for actual onboarding
- ‚úÖ Open Slack modal via `views.open`
- ‚úÖ Handle all logic in interactive handler
- ‚úÖ Docs page shows PostInstallBanner to guide user back to Slack

### Modal Stacking Pattern
- **`views.open`**: Use for fresh modals from slash commands or message buttons
- **`views.push`**: Use when opening a modal from within another modal (e.g., "Edit Flags" button in settings)
- **`views.update`**: Use to replace current modal content (avoids stack overflow, max 3 levels)
- **Close button**: Use "Back" for pushed modals (returns to previous), "Cancel" for root modals

### Stale Parent Modal Problem ‚ö†Ô∏è CRITICAL
When user modifies data in a child modal (e.g., delete flag in Edit Flags), the parent modal (Settings) has stale data. If user clicks Save on parent, it overwrites the changes.

**Solution: Pass parent view ID and refresh after changes**
```typescript
// 1. When opening child modal, store parent view_id in private_metadata
await workspaceSlack.views.push({
  trigger_id: triggerId,
  view: {
    callback_id: 'child_modal',
    private_metadata: JSON.stringify({ parentViewId: payload.view?.id }),
    // ...
  }
});

// 2. After successful operation in child, refresh parent via after()
const metadata = JSON.parse(view.private_metadata);
if (metadata.parentViewId) {
  after(async () => {
    await workspaceSlack.views.update({
      view_id: metadata.parentViewId,
      view: { /* rebuilt parent modal with fresh data */ }
    });
  });
}
```

### Modal Stack Overflow Prevention
Slack limits modal stack to 3 levels. When nesting modals (e.g., Settings ‚Üí Edit Flags ‚Üí Delete confirmation):
- **Don't**: Use `views.push` for every sub-operation (causes `push_limit_reached` error)
- **Do**: Use `views.update` to replace current modal content for sub-operations
- **Pattern**: Push once for main child modal, update in-place for further actions

### Email Collection
- ‚ùå Don't ask for email in modal
- ‚úÖ Fetch from Slack API using `users:read.email` scope
- ‚úÖ Email stored during user creation

### Optional Announcement
- Admin can optionally share Clarity installation with workspace
- Uses `sendWorkspaceAnnouncement()` function
- Posted to selected channel with interactive buttons

### Background Processing
- Use `after()` for any post-submission work
- Respond immediately to prevent Slack timeout
- Log errors but don't block modal close

### Slack Block Kit Constraints
- **Overflow menu**: Maximum 5 options allowed
- **Checkboxes in input blocks**: Can't have accessories - use for simple enable/disable
- **Checkboxes in section blocks**: Can have overflow menu accessory for additional actions
- **Prefer checkboxes over toggle buttons**: More compact, standard UX pattern
